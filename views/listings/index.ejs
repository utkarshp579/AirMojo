<%- layout("/layouts/boilerplate") %>

<!-- <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AirMojo</title>
</head> -->
<body>
    <h3>All Listings</h3>
    
    <!-- Filter Section -->
    <div class="filter-section">
        <form action="/listings" method="GET" id="filterForm">
            
            <!-- Price Range -->
            <div class="filter-group">
                <label for="minPrice">Min Price (₹)</label>
                <input type="number" id="minPrice" name="minPrice" placeholder="Min" min="0" value="<%= (typeof filters !== 'undefined' && filters.minPrice) || '' %>">
            </div>
            
            <div class="filter-group">
                <label for="maxPrice">Max Price (₹)</label>
                <input type="number" id="maxPrice" name="maxPrice" placeholder="Max" min="0" value="<%= (typeof filters !== 'undefined' && filters.maxPrice) || '' %>">
            </div>
            
            <!-- Rating Filter -->
            <div class="filter-group">
                <label for="minRating">Minimum Rating</label>
                <select id="minRating" name="minRating">
                    <option value="">Any Rating</option>
                    <option value="1" <%= (typeof filters !== 'undefined' && filters.minRating == '1') ? 'selected' : '' %>>1+ ★</option>
                    <option value="2" <%= (typeof filters !== 'undefined' && filters.minRating == '2') ? 'selected' : '' %>>2+ ★★</option>
                    <option value="3" <%= (typeof filters !== 'undefined' && filters.minRating == '3') ? 'selected' : '' %>>3+ ★★★</option>
                    <option value="4" <%= (typeof filters !== 'undefined' && filters.minRating == '4') ? 'selected' : '' %>>4+ ★★★★</option>
                    <option value="5" <%= (typeof filters !== 'undefined' && filters.minRating == '5') ? 'selected' : '' %>>5 ★★★★★</option>
                </select>
            </div>
            
            <!-- Location Search -->
            <div class="filter-group">
                <label for="location">Location</label>
                <input type="text" id="location" name="location" placeholder="e.g., Mumbai, Goa" value="<%= (typeof filters !== 'undefined' && filters.location) || '' %>">
            </div>
            
            <!-- Country Search -->
            <div class="filter-group">
                <label for="country">Country</label>
                <input type="text" id="country" name="country" placeholder="e.g., India" value="<%= (typeof filters !== 'undefined' && filters.country) || '' %>">
            </div>
            
            <!-- Action Buttons -->
            <button type="submit" class="btn-apply">Apply Filters</button>
            <button type="button" id="clearFilters" class="btn-clear">Clear All</button>
        </form>
        
        <!-- Active Filter Badges -->
        <div id="activeFilters" class="mt-3"></div>
    </div>
    
    <!-- Results Count -->
    <% if (allListings.length === 0) { %>
        <div class="alert alert-info" role="alert">
            No listings found matching your filters. Try adjusting your search criteria.
        </div>
    <% } else { %>
        <p class="text-muted mb-3"><%= allListings.length %> listing<%= allListings.length !== 1 ? 's' : '' %> found</p>
    <% } %>
    
    <!-- <form action="/listings/new" method="get">
        <button>Create New Listing</button>
    </form> -->
    <div class="row row-cols-lg-3 row-cols-md-2 row-cols-sm-1">
        <%for(let listing of allListings){  %>
            <a href="/listings/<%= listing._id%>" class="listing-link" >
                <div class="card col listing-card" >
                    <img src="<%= listing.image.url %>" class="card-img-top" alt="listing_image" style="height: 20rem;">
                    <div class="card-img-overlay"></div>
                    <div class="card-body">
                        <p class="card-text">
                            <b><%= listing.title %></b> <br>
                            
                            <!-- Rating Display -->
                            <span class="rating">
                                <% if (listing.reviews && listing.reviews.length > 0) { %>
                                    <% const avgRating = listing.averageRating || 0; %>
                                    <% if (avgRating > 0) { %>
                                        <% const fullStars = Math.floor(avgRating); %>
                                        <% const emptyStars = 5 - fullStars; %>
                                        <span class="stars">
                                            <%= '★'.repeat(fullStars) %><%= '☆'.repeat(emptyStars) %>
                                        </span>
                                        <span class="rating-number">(<%= avgRating.toFixed(1) %>)</span>
                                        <small class="review-count"><%= listing.reviews.length %> review<%= listing.reviews.length !== 1 ? 's' : '' %></small>
                                    <% } else { %>
                                        <small class="text-muted">No reviews yet</small>
                                    <% } %>
                                <% } else { %>
                                    <small class="text-muted">No reviews yet</small>
                                <% } %>
                            </span>
                            <br>
                            
                            &#x20B9; <%= listing.price.toLocaleString("en-In") %> / night
                        </p> 
                        
                    </div>
                </div> 
            </a>
        <% } %>
    </div>

    <!-- <ul>
        <%for(let listing of allListings){  %> 
             <li><a href="listings/<%= listing._id %>"><%= listing.title %>  </a></li>   
         <% } %> 
     </ul> --> 
    
</body>
<!-- </html> -->
